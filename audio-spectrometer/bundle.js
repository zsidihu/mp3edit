const spectrum=document.getElementById("spectrum"),analyzer=document.getElementById("analyzer"),controls=document.getElementById("controls"),clearBtn=document.getElementById("clearBtn"),aboutBtn=document.getElementById("aboutBtn"),freqAxis=document.getElementById("freqAxis"),wgl=spectrum.getContext("webgl"),ctx=analyzer.getContext("2d"),fftSize=8192,timeBins=512,freqBins=4096;let dataArray,byteArray,peakSpectrum=null,spectrogram=new Uint8Array(2097152),audioCtx=null,analyser=null;const vsSource="attribute vec2 aPos;varying vec2 vUV;void main(){vUV=aPos*0.5+0.5;gl_Position=vec4(aPos,0.0,1.0);}",fsSource="precision mediump float;varying vec2 vUV;uniform sampler2D uTex;vec3 viridis(float t){t=clamp(t,0.0,1.0);if(t<0.0625) return mix(vec3(0.267,0.004,0.329),vec3(0.282,0.140,0.457),t/0.0625); else if(t<0.125) return mix(vec3(0.282,0.140,0.457),vec3(0.253,0.265,0.530),(t-0.0625)/0.0625); else if(t<0.1875) return mix(vec3(0.253,0.265,0.530),vec3(0.206,0.372,0.553),(t-0.125)/0.0625); else if(t<0.25) return mix(vec3(0.206,0.372,0.553),vec3(0.163,0.471,0.558),(t-0.1875)/0.0625); else if(t<0.3125) return mix(vec3(0.163,0.471,0.558),vec3(0.127,0.566,0.550),(t-0.25)/0.0625); else if(t<0.375) return mix(vec3(0.127,0.566,0.550),vec3(0.134,0.658,0.518),(t-0.3125)/0.0625); else if(t<0.4375) return mix(vec3(0.134,0.658,0.518),vec3(0.230,0.745,0.452),(t-0.375)/0.0625); else if(t<0.5) return mix(vec3(0.230,0.745,0.452),vec3(0.372,0.824,0.376),(t-0.4375)/0.0625); else if(t<0.5625) return mix(vec3(0.372,0.824,0.376),vec3(0.558,0.894,0.306),(t-0.5)/0.0625); else if(t<0.625) return mix(vec3(0.558,0.894,0.306),vec3(0.735,0.951,0.166),(t-0.5625)/0.0625); else if(t<0.6875) return mix(vec3(0.735,0.951,0.166),vec3(0.878,0.971,0.100),(t-0.625)/0.0625); else if(t<0.75) return mix(vec3(0.878,0.971,0.100),vec3(0.993,0.906,0.144),(t-0.6875)/0.0625); else if(t<0.8125) return mix(vec3(0.993,0.906,0.144),vec3(0.995,0.863,0.258),(t-0.75)/0.0625); else if(t<0.875) return mix(vec3(0.995,0.863,0.258),vec3(0.995,0.750,0.395),(t-0.8125)/0.0625); else if(t<0.9375) return mix(vec3(0.995,0.750,0.395),vec3(0.987,0.560,0.496),(t-0.875)/0.0625); else return mix(vec3(0.987,0.560,0.496),vec3(0.993,0.906,0.144),(t-0.9375)/0.0625);}void main(){float t=texture2D(uTex,vUV).r;gl_FragColor=vec4(viridis(t),1.0);}",ResizeCanvas=()=>{spectrum.width=window.innerWidth,spectrum.height=window.innerHeight,wgl.viewport(0,0,wgl.drawingBufferWidth,wgl.drawingBufferHeight),drawFreqAxis()},compileShader=(e,t)=>{const r=wgl.createShader(t);if(wgl.shaderSource(r,e),wgl.compileShader(r),!wgl.getShaderParameter(r,wgl.COMPILE_STATUS))throw new Error(wgl.getShaderInfoLog(r));return r},createProgram=(e,t)=>{const r=compileShader(e,wgl.VERTEX_SHADER),a=compileShader(t,wgl.FRAGMENT_SHADER),l=wgl.createProgram();if(wgl.attachShader(l,r),wgl.attachShader(l,a),wgl.linkProgram(l),!wgl.getProgramParameter(l,wgl.LINK_STATUS))throw new Error(wgl.getProgramInfoLog(l));return l},program=createProgram(vsSource,fsSource);wgl.useProgram(program);const vertices=new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),vertexBuf=wgl.createBuffer();wgl.bindBuffer(wgl.ARRAY_BUFFER,vertexBuf),wgl.bufferData(wgl.ARRAY_BUFFER,vertices,wgl.STATIC_DRAW);const aPosLoc=wgl.getAttribLocation(program,"aPos");wgl.enableVertexAttribArray(aPosLoc),wgl.vertexAttribPointer(aPosLoc,2,wgl.FLOAT,!1,0,0);const tex=wgl.createTexture();wgl.activeTexture(wgl.TEXTURE0),wgl.bindTexture(wgl.TEXTURE_2D,tex),wgl.texParameteri(wgl.TEXTURE_2D,wgl.TEXTURE_MIN_FILTER,wgl.NEAREST),wgl.texParameteri(wgl.TEXTURE_2D,wgl.TEXTURE_MAG_FILTER,wgl.NEAREST),wgl.texParameteri(wgl.TEXTURE_2D,wgl.TEXTURE_WRAP_S,wgl.CLAMP_TO_EDGE),wgl.texParameteri(wgl.TEXTURE_2D,wgl.TEXTURE_WRAP_T,wgl.CLAMP_TO_EDGE);const uTexLoc=wgl.getUniformLocation(program,"uTex");wgl.uniform1i(uTexLoc,0);const controlApp=async e=>{const t=e.target;if("start"===t.dataset.button){t.dataset.button="pause",audioCtx=new(window.AudioContext||window.webkitAudioContext);try{const e=await navigator.mediaDevices.getUserMedia({audio:{noiseSuppression:!0,echoCancellation:!0,autoGainControl:!1}}),t=audioCtx.createMediaStreamSource(e);analyser=audioCtx.createAnalyser(),analyser.fftSize=8192,analyser.minDecibels=-120,analyser.maxDecibels=-10,analyser.smoothingTimeConstant=.8,t.connect(analyser),dataArray=new Float32Array(analyser.frequencyBinCount),byteArray=new Uint8Array(analyser.frequencyBinCount),drawLoop()}catch(e){alert("Hiba a mikrofon elérésénél: "+e.message)}}else if("pause"===t.dataset.button){if(t.dataset.button="start",!audioCtx)return;audioCtx.close(),audioCtx=null,analyser=null,ctx.clearRect(0,0,analyzer.width,analyzer.height)}},drawLoop=()=>{analyser&&(drawSprectumGL(),drawAnalyzer2D(),requestAnimationFrame(drawLoop))},applyBlackmanHarris=e=>{const t=e.length,r=new Float32Array(t);for(let a=0;a<t;a++){const l=.14128,c=.01168,n=.35875-.48829*Math.cos(2*Math.PI*a/(t-1))+l*Math.cos(4*Math.PI*a/(t-1))-c*Math.cos(6*Math.PI*a/(t-1));r[a]=e[a]*n}return r},drawSprectumGL=()=>{analyser.getFloatFrequencyData(dataArray);for(let e=0;e<4096;e++){for(let t=0;t<511;t++)spectrogram[512*e+t]=spectrogram[512*e+t+1];const t=0,r=20,a=audioCtx.sampleRate/2,l=e/4095;let c;if(l<r/a)c=t+(r-t)*l/(r/a);else{const e=(l-r/a)/(1-r/a);c=r*Math.pow(a/r,e)}const n=8192*c/audioCtx.sampleRate,o=Math.floor(n),s=Math.min(o+1,4095),i=n-o;let w=(dataArray[o]-analyser.minDecibels)/(analyser.maxDecibels-analyser.minDecibels)*(1-i)+(dataArray[s]-analyser.minDecibels)/(analyser.maxDecibels-analyser.minDecibels)*i;w<.08&&(w=0);w=(spectrogram[512*e+512-2]/255+w)/2,w=Math.min(Math.max(w,0),1),spectrogram[512*e+512-1]=Math.floor(255*w)}wgl.bindTexture(wgl.TEXTURE_2D,tex),wgl.texImage2D(wgl.TEXTURE_2D,0,wgl.LUMINANCE,512,4096,0,wgl.LUMINANCE,wgl.UNSIGNED_BYTE,spectrogram),wgl.viewport(0,0,spectrum.width,spectrum.height),wgl.clear(wgl.COLOR_BUFFER_BIT),wgl.drawArrays(wgl.TRIANGLES,0,6)},initAnalyzer=()=>{peakSpectrum=new Float32Array(analyser.frequencyBinCount)},drawAnalyzer2D=()=>{const e=analyzer.width,t=analyzer.height;analyser.getByteFrequencyData(byteArray),peakSpectrum||(peakSpectrum=new Float32Array(byteArray.length));for(let e=0;e<byteArray.length;e++){const t=byteArray[e]/255;t>peakSpectrum[e]&&(peakSpectrum[e]=t)}ctx.clearRect(0,0,e,t),ctx.beginPath();let r=!0;for(let a=0;a<byteArray.length;a+=10){const l=byteArray[a]/255;if(l<.01)continue;const c=Math.log10(1+a/(byteArray.length-1)*9)*e,n=t-l*t;if(r)ctx.moveTo(c,n),r=!1;else{const r=Math.log10(1+(a-1)/(byteArray.length-1)*9)*e,l=t-byteArray[a-1]/255*t;ctx.quadraticCurveTo((r+c)/2,(l+n)/2,c,n)}}ctx.strokeStyle="#ffffff",ctx.lineWidth=1,ctx.stroke(),ctx.beginPath(),r=!0;for(let a=0;a<peakSpectrum.length;a+=10){const l=peakSpectrum[a];if(l<.01)continue;const c=Math.log10(1+a/(peakSpectrum.length-1)*9)*e,n=t-l*t;if(r)ctx.moveTo(c,n),r=!1;else{const r=Math.log10(1+(a-1)/(peakSpectrum.length-1)*9)*e,l=t-peakSpectrum[a-1]*t;ctx.quadraticCurveTo((r+c)/2,(l+n)/2,c,n)}}ctx.strokeStyle="aqua",ctx.lineWidth=1,ctx.stroke()},drawFreqAxis=()=>{freqAxis.replaceChildren();const e=spectrum.height,t=audioCtx?audioCtx.sampleRate/2:22050;for(let r=0;r<=10;r++){const a=r/10,l=20*Math.pow(t/20,a),c=e*(1-Math.log10(l/20)/Math.log10(t/20)),n=document.createElement("div");n.style.top=c+"px",n.style.left="5px",n.textContent=Math.round(l)+" Hz",freqAxis.appendChild(n)}};clearBtn.addEventListener("click",()=>{peakSpectrum=null,spectrogram.fill(0),ctx.clearRect(0,0,analyzer.width,analyzer.height),wgl.bindTexture(wgl.TEXTURE_2D,tex),wgl.texImage2D(wgl.TEXTURE_2D,0,wgl.LUMINANCE,512,4096,0,wgl.LUMINANCE,wgl.UNSIGNED_BYTE,spectrogram),wgl.drawArrays(wgl.TRIANGLES,0,6)}),controls.addEventListener("click",controlApp),aboutBtn.addEventListener("click",()=>document.querySelector(".version").classList.add("visible")),window.addEventListener("resize",ResizeCanvas),document.addEventListener("click",e=>{"About Box"!==(e.target.getAttribute("aria-label")??null)&&"aboutBtn"!==e.target.id&&document.querySelector(".version").classList.remove("visible")}),ResizeCanvas();